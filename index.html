<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>Lotus ¬∑ Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="icon" href="data:,">
<style>
  :root {
    --bg:#0b0b14; --card:#141428; --card2:#111123; --line:#2b2b44;
    --txt:#ffffff; --muted:rgba(255,255,255,.72);
    --btn:#6c5cff; --btn2:#2a2a44; --danger:#ff4d4d; --ok:#2dd4bf; --warn:#ffb55a;
    --shadow:0 10px 30px rgba(0,0,0,.25);
    --r:16px;
  }
  *{box-sizing:border-box}
  body{
    margin:0; padding:22px;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
    background:var(--bg); color:var(--txt);
    max-width:1080px; margin-left:auto; margin-right:auto;
  }
  h1,h2,h3{margin:0}
  .muted{color:var(--muted)}
  .small{font-size:12px}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  .card{
    background:var(--card);
    border:1px solid rgba(255,255,255,.06);
    border-radius:var(--r);
    padding:16px;
    box-shadow:var(--shadow);
    margin-bottom:14px;
  }
  .card.flat{box-shadow:none}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .col{display:flex;flex-direction:column;gap:10px}
  .topbar{display:flex;justify-content:space-between;align-items:flex-start;gap:14px;flex-wrap:wrap;margin-bottom:14px}
  .right{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .titleBlock{display:flex;flex-direction:column;gap:6px}
  .titleBlock .muted{line-height:1.35}
  input,select,button{
    border-radius:14px;
    padding:10px 12px;
    border:1px solid rgba(255,255,255,.10);
    background:#0f0f1f;
    color:var(--txt);
    outline:none;
  }
  input::placeholder{color:rgba(255,255,255,.45)}
  select{min-width:340px}
  button{
    background:var(--btn);
    border:1px solid rgba(255,255,255,.10);
    font-weight:800;
    cursor:pointer;
  }
  button.secondary{background:var(--btn2)}
  button.ghost{background:transparent}
  button.danger{background:rgba(255,77,77,.16); color:#ffb0b0; border:1px solid rgba(255,77,77,.28)}
  button.danger:hover{background:rgba(255,77,77,.22)}
  button:disabled{opacity:.5; cursor:not-allowed}
  .iconBtn{
    width:42px; min-width:42px; height:42px;
    display:inline-flex; align-items:center; justify-content:center;
    padding:0;
  }
  .pill{
    display:inline-flex; gap:8px; align-items:center;
    padding:4px 10px; border-radius:999px;
    font-size:12px;
    background:rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.08);
  }
  .pill.ok{background:rgba(45,212,191,.14); border-color:rgba(45,212,191,.28)}
  .pill.draft{background:rgba(255,181,90,.12); border-color:rgba(255,181,90,.24)}
  .hint{
    margin-top:8px;
    font-size:12px;
    color:rgba(255,255,255,.72);
    line-height:1.4;
  }
  .divider{height:1px; background:rgba(255,255,255,.08); margin:12px 0}
  pre{
    white-space:pre-wrap; word-break:break-word;
    background:#0f0f1f;
    border:1px solid rgba(255,255,255,.10);
    border-radius:14px;
    padding:10px;
    margin:10px 0 0;
  }
  table{width:100%; border-collapse:collapse; margin-top:10px}
  th,td{border-bottom:1px solid var(--line); padding:10px; text-align:left; font-size:13px; vertical-align:top}
  th{opacity:.85; font-weight:800}
  .headerRow{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
  .grid{display:grid; grid-template-columns:1fr; gap:12px}
  @media (min-width:980px){ .grid{grid-template-columns:1fr 1fr} }
  .status{margin-top:8px; font-size:12px; color:rgba(255,255,255,.75)}

  /* Modal */
  .modalBackdrop{position:fixed; inset:0; background:rgba(0,0,0,.62); display:none; align-items:center; justify-content:center; padding:16px; z-index:999}
  .modalBackdrop.open{display:flex}
  .modal{width:100%; max-width:820px; background:var(--card); border:1px solid rgba(255,255,255,.10); border-radius:18px; padding:16px; box-shadow:0 24px 60px rgba(0,0,0,.45)}
  .modalTop{display:flex;justify-content:space-between;align-items:center;gap:12px}
  .modalFooter{display:flex;justify-content:flex-end;gap:10px;flex-wrap:wrap;margin-top:12px}

  /* Step headings */
  .stepTitle{display:flex;align-items:center;gap:10px}
  .stepDot{width:24px;height:24px;border-radius:8px;background:rgba(255,255,255,.08);display:inline-flex;align-items:center;justify-content:center;font-weight:900;font-size:12px;border:1px solid rgba(255,255,255,.10)}

  /* Disabled overlay hint */
  .locked{opacity:.55}
</style>
</head>
<body>

<div class="topbar">
  <div class="titleBlock">
    <h2>Lotus ¬∑ Admin</h2>
    <div class="muted small">
      –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–ª–∏–∑–∞–º–∏, —Å–æ–æ–±—â–µ—Å—Ç–≤–∞–º–∏ –∏ –∑–∞–≥—Ä—É–∑–∫–∞–º–∏. –ü–æ—Ç–æ–∫: –≤—ã–±–µ—Ä–∏ —Ä–µ–ª–∏–∑ ‚Üí –≤—ã–±–µ—Ä–∏/–¥–æ–±–∞–≤—å —Å–æ–æ–±—â–µ—Å—Ç–≤–æ ‚Üí –∑–∞–≥—Ä—É–∑–∏ VK-—Ç–∞–±–ª–∏—Ü—ã ‚Üí –∑–∞–≥—Ä—É–∑–∏ —Å—Ç—Ä–∏–º—ã ‚Üí –æ–ø—É–±–ª–∏–∫—É–π.
    </div>
  </div>

  <!-- Publish in top-right -->
  <div class="right">
    <button id="btn-refresh" class="iconBtn secondary" type="button" title="–û–±–Ω–æ–≤–∏—Ç—å">‚Üª</button>
    <button id="btn-publish" type="button" disabled>–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<!-- Modal -->
<div id="modal-backdrop" class="modalBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <div class="modalTop">
      <h3 id="modal-title">‚Äî</h3>
      <button id="btn-close-modal" class="iconBtn ghost" type="button" title="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
    </div>
    <div class="divider"></div>
    <div id="modal-body"></div>
    <div class="modalFooter" id="modal-footer"></div>
  </div>
</div>

<script>
/* ===============================
   CONFIG
================================ */
const API_URL = 'https://functions.yandexcloud.net/d4evbekf5us7hbjid3m3';

/* ===============================
   UTILITIES
================================ */
const $ = (id) => document.getElementById(id);

function esc_(s){
  return String(s ?? '').replace(/[&<>"']/g, m => ({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m]));
}
function setOut(id, obj){
  $(id).textContent = (typeof obj === 'string') ? obj : JSON.stringify(obj, null, 2);
}

async function api(action, data){
  const res = await fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type":"application/json" },
    body: JSON.stringify({ action, data })
  });
  const json = await res.json().catch(()=>null);
  if (!json) throw new Error('–û—Ç–≤–µ—Ç –Ω–µ JSON (–ø—Ä–æ–≤–µ—Ä—å Yandex Function)');
  if (!json.ok) throw new Error(json.error || 'Unknown API error');
  return json.data;
}

function readExcelFirstSheet(file){
  return new Promise((resolve, reject) => {
    if (!file) return reject(new Error('–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω'));
    const r = new FileReader();
    r.onload = e => {
      try {
        const wb = XLSX.read(e.target.result, { type:'binary' });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(ws, { header: 1, blankrows: false });
        resolve(rows);
      } catch (err){ reject(err); }
    };
    r.onerror = reject;
    r.readAsBinaryString(file);
  });
}

function setStatus(text, isErr=false){
  const el = $('global-status');
  el.textContent = text;
  el.style.color = isErr ? "#ff9d9d" : "#b9ffcf";
  el.style.opacity = "1";
  setTimeout(()=>{ el.style.opacity = "0.8"; }, 1500);
}

function confirmDanger_(text){ return window.confirm(text); }

/* ===============================
   MODAL
================================ */
function openModal(title, bodyHtml, footerHtml){
  $('modal-title').textContent = title;
  $('modal-body').innerHTML = bodyHtml;
  $('modal-footer').innerHTML = footerHtml || '';
  $('modal-backdrop').classList.add('open');
  $('modal-backdrop').setAttribute('aria-hidden','false');
}
function closeModal(){
  $('modal-backdrop').classList.remove('open');
  $('modal-backdrop').setAttribute('aria-hidden','true');
}
$('btn-close-modal').addEventListener('click', closeModal);
$('modal-backdrop').addEventListener('click', (e)=>{ if (e.target === $('modal-backdrop')) closeModal(); });
document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') closeModal(); });

/* ===============================
   STATE + PERSISTENCE
================================ */
const LS_KEY = "lotus_admin_state_v1";
const state = {
  releasesHeader: [],
  releasesRows: [],
  communitiesHeader: [],
  communitiesRows: [],
  selectedReleaseId: "",
  selectedCommunityId: ""
};

function saveState_(){
  try {
    localStorage.setItem(LS_KEY, JSON.stringify({
      selectedReleaseId: state.selectedReleaseId,
      selectedCommunityId: state.selectedCommunityId
    }));
  } catch (_) {}
}
function loadState_(){
  try {
    const raw = localStorage.getItem(LS_KEY);
    if (!raw) return;
    const obj = JSON.parse(raw);
    state.selectedReleaseId = String(obj.selectedReleaseId || "");
    state.selectedCommunityId = String(obj.selectedCommunityId || "");
  } catch (_) {}
}

function idx_(header, name){ return header.indexOf(name); }
function getReleaseById_(id){
  const ridx = idx_(state.releasesHeader,'release_id');
  return state.releasesRows.find(r => String(r[ridx]) === String(id)) || null;
}
function getCommunitiesForRelease_(release_id){
  const ridx = idx_(state.communitiesHeader,'release_id');
  const cid = idx_(state.communitiesHeader,'community_id');
  const cname = idx_(state.communitiesHeader,'community_name');
  const sidx = idx_(state.communitiesHeader,'sort_order');
  return state.communitiesRows
    .filter(r => String(r[ridx]) === String(release_id))
    .map(r => ({
      release_id: String(release_id),
      community_id: String(r[cid] ?? ''),
      community_name: String(r[cname] ?? ''),
      sort_order: Number(r[sidx] ?? 0)
    }))
    .sort((a,b)=>a.sort_order-b.sort_order);
}

function ensureValidSelections_(){
  // release
  if (state.selectedReleaseId){
    const rel = getReleaseById_(state.selectedReleaseId);
    if (!rel) state.selectedReleaseId = "";
  }
  // community
  if (state.selectedReleaseId){
    const list = getCommunitiesForRelease_(state.selectedReleaseId);
    if (!list.length) {
      state.selectedCommunityId = "";
    } else {
      const ok = list.some(c => c.community_id === state.selectedCommunityId);
      if (!ok) state.selectedCommunityId = list[0].community_id;
    }
  } else {
    state.selectedCommunityId = "";
  }
}

/* ===============================
   RENDER
================================ */
function renderReleaseSelect(){
  const ridx = idx_(state.releasesHeader,'release_id');
  const titleIdx = idx_(state.releasesHeader,'title');
  const pubIdx = idx_(state.releasesHeader,'published');
  const slugIdx = idx_(state.releasesHeader,'login_slug');

  const options = state.releasesRows.map(r=>{
    const id = String(r[ridx] ?? '');
    const title = String(r[titleIdx] ?? '');
    const slug = String(r[slugIdx] ?? '');
    const pub = (r[pubIdx] === true || String(r[pubIdx]).toLowerCase() === 'true');
    const mark = pub ? 'üü¢' : 'üü°';
    return `<option value="${esc_(id)}">${mark} ${esc_(title)} (${esc_(slug)})</option>`;
  }).join('');

  $('release-select').innerHTML = `<option value="">‚Äî –≤—ã–±—Ä–∞—Ç—å —Ä–µ–ª–∏–∑ ‚Äî</option>` + options;
  $('release-select').value = state.selectedReleaseId || "";
}

function renderReleaseSummary(){
  const rel = state.selectedReleaseId ? getReleaseById_(state.selectedReleaseId) : null;
  if (!rel){
    $('release-summary').innerHTML = `<div class="muted">–†–µ–ª–∏–∑ –Ω–µ –≤—ã–±—Ä–∞–Ω.</div>`;
    $('btn-publish').disabled = true;
    $('btn-publish').textContent = '–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å';
    $('btn-publish').classList.remove('danger');
    return;
  }

  const h = state.releasesHeader;
  const title = rel[idx_(h,'title')] ?? '';
  const slug = rel[idx_(h,'login_slug')] ?? '';
  const pass = rel[idx_(h,'password')] ?? '';
  const publishedRaw = rel[idx_(h,'published')];
  const published = (publishedRaw === true || String(publishedRaw).toLowerCase() === 'true');
  const rid = rel[idx_(h,'release_id')] ?? '';
  const ps = rel[idx_(h,'period_start')] ?? '';
  const pe = rel[idx_(h,'period_end')] ?? '';

  $('btn-publish').disabled = false;
  $('btn-publish').textContent = published ? '–°–Ω—è—Ç—å —Å –ø—É–±–ª–∏–∫–∞—Ü–∏–∏' : '–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å';
  $('btn-publish').classList.toggle('danger', published);

  $('release-summary').innerHTML = `
    <div class="row" style="justify-content:space-between;align-items:flex-start">
      <div class="col" style="gap:4px">
        <div><b>${esc_(title)}</b></div>
        <div class="small muted">
          <span class="mono">${esc_(rid)}</span>
          ¬∑ slug: <span class="mono">${esc_(slug)}</span>
          ¬∑ –ø–∞—Ä–æ–ª—å: <span class="mono">${esc_(pass)}</span>
        </div>
        <div class="small muted">${esc_(ps)} ‚Äî ${esc_(pe)}</div>
      </div>
      <div class="row" style="gap:8px">
        <span class="pill ${published ? 'ok' : 'draft'}">${published ? '–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ' : '–ß–µ—Ä–Ω–æ–≤–∏–∫'}</span>
        <button class="iconBtn ghost" type="button" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–ª–∏–∑" onclick="openEditReleaseModal()">‚úé</button>
        <button class="iconBtn danger" type="button" title="–£–¥–∞–ª–∏—Ç—å —Ä–µ–ª–∏–∑" onclick="deleteRelease()">‚úï</button>
      </div>
    </div>
  `;
}

function renderCommunityBlock(){
  const relId = state.selectedReleaseId;
  const list = relId ? getCommunitiesForRelease_(relId) : [];

  // dropdown always visible; if none -> only placeholder
  const options = list.map(c => `<option value="${esc_(c.community_id)}">${esc_(c.community_name)} ¬∑ ${esc_(c.community_id)}</option>`).join('');
  $('community-select').innerHTML = `<option value="">‚Äî –≤—ã–±—Ä–∞—Ç—å —Å–æ–æ–±—â–µ—Å—Ç–≤–æ ‚Äî</option>` + options;
  $('community-select').value = state.selectedCommunityId || "";

  if (!relId){
    $('community-summary').innerHTML = `<div class="muted small">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ —Ä–µ–ª–∏–∑.</div>`;
    $('community-table').innerHTML = '';
    return;
  }

  if (!list.length){
    // show "plus" as primary action
    $('community-summary').innerHTML = `
      <div class="row" style="justify-content:space-between;align-items:flex-start">
        <div class="col" style="gap:6px">
          <div class="muted small">–°–æ–æ–±—â–µ—Å—Ç–≤–∞ –¥–ª—è —Ä–µ–ª–∏–∑–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</div>
          <div class="hint">
            –ù–∞–∂–º–∏ ¬´Ôºã¬ª, –≤–≤–µ–¥–∏ <span class="mono">community_id</span> –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ. –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –º–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∂–∞—Ç—å VK-–≤—ã–≥—Ä—É–∑–∫–∏ (–∫–∞–º–ø–∞–Ω–∏–∏/–≥—Ä—É–ø–ø—ã/–æ–±—ä—è–≤–ª–µ–Ω–∏—è/—Å—Ç—Ä–∞–Ω—ã/–≥–æ—Ä–æ–¥–∞/–¥–µ–º–æ–≥—Ä–∞—Ñ–∏—è) –∏–º–µ–Ω–Ω–æ –ø–æ —ç—Ç–æ–º—É —Å–æ–æ–±—â–µ—Å—Ç–≤—É.
          </div>
        </div>
        <button class="iconBtn" type="button" title="–î–æ–±–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ—Å—Ç–≤–æ" onclick="openAddCommunityModal()">Ôºã</button>
      </div>
    `;
    $('community-table').innerHTML = '';
    return;
  }

  const selected = list.find(x => x.community_id === state.selectedCommunityId) || list[0];
  if (!state.selectedCommunityId) state.selectedCommunityId = selected.community_id;

  $('community-summary').innerHTML = `
    <div class="row" style="justify-content:space-between;align-items:flex-start">
      <div class="col" style="gap:4px">
        <div><b>${esc_(selected.community_name)}</b></div>
        <div class="small muted">community_id: <span class="mono">${esc_(selected.community_id)}</span></div>
        <div class="hint">
          –í—Å–µ –∑–∞–≥—Ä—É–∑–∫–∏ VK –Ω–∏–∂–µ –±—É–¥—É—Ç –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É <span class="mono">community_id</span>. –î–ª—è –∫–æ–ª–ª–∞–±–æ—Ä–∞—Ü–∏–π –¥–æ–±–∞–≤–ª—è–π —Å–æ–æ–±—â–µ—Å—Ç–≤–∞ –ø–æ –æ–¥–Ω–æ–º—É —á–µ—Ä–µ–∑ ¬´Ôºã¬ª.
        </div>
      </div>
      <div class="row" style="gap:8px">
        <button class="iconBtn" type="button" title="–î–æ–±–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ—Å—Ç–≤–æ" onclick="openAddCommunityModal()">Ôºã</button>
        <button class="iconBtn ghost" type="button" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ—Å—Ç–≤–æ" onclick="openEditCommunityModal()">‚úé</button>
        <button class="iconBtn danger" type="button" title="–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ—Å—Ç–≤–æ" onclick="deleteCommunity()">‚úï</button>
      </div>
    </div>
  `;

  const rows = list.map(c => `
    <tr>
      <td>${esc_(c.community_name)}</td>
      <td class="mono">${esc_(c.community_id)}</td>
      <td class="small muted">${esc_(c.sort_order)}</td>
      <td>
        <div class="row" style="gap:8px">
          <button class="secondary" type="button" onclick="selectCommunity('${esc_(c.community_id)}')">–í—ã–±—Ä–∞—Ç—å</button>
          <button class="iconBtn ghost" type="button" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" onclick="openEditCommunityModal('${esc_(c.community_id)}')">‚úé</button>
          <button class="iconBtn danger" type="button" title="–£–¥–∞–ª–∏—Ç—å" onclick="deleteCommunity('${esc_(c.community_id)}')">‚úï</button>
        </div>
      </td>
    </tr>
  `).join('');

  $('community-table').innerHTML = `
    <table>
      <thead><tr>
        <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>community_id</th><th>sort</th><th>–î–µ–π—Å—Ç–≤–∏—è</th>
      </tr></thead>
      <tbody>${rows}</tbody>
    </table>
  `;
}

function renderLocks(){
  const hasRelease = !!state.selectedReleaseId;
  const hasCommunity = !!state.selectedCommunityId;

  // VK blocks need both
  document.querySelectorAll('[data-requires="community"]').forEach(el => {
    el.disabled = !(hasRelease && hasCommunity);
  });

  // Streams need only release
  document.querySelectorAll('[data-requires="release"]').forEach(el => {
    el.disabled = !hasRelease;
  });

  // visual hint on blocks
  document.querySelectorAll('[data-block="vk"]').forEach(card => {
    card.classList.toggle('locked', !(hasRelease && hasCommunity));
  });
  document.querySelectorAll('[data-block="streams"]').forEach(card => {
    card.classList.toggle('locked', !hasRelease);
  });
}

function renderAll(){
  ensureValidSelections_();
  renderReleaseSelect();
  renderReleaseSummary();
  renderCommunityBlock();
  renderLocks();
  saveState_();
}

function selectCommunity(cid){
  state.selectedCommunityId = cid || "";
  $('community-select').value = state.selectedCommunityId;
  renderCommunityBlock();
  renderLocks();
  saveState_();
  setStatus('–í—ã–±—Ä–∞–Ω–æ community_id: ' + state.selectedCommunityId);
}

/* ===============================
   DATA LOAD
================================ */
async function refresh(){
  $('btn-refresh').disabled = true;
  try{
    const data = await api('bootstrapAdmin', {});
    state.releasesHeader = data.releasesHeader || [];
    state.releasesRows = data.releases || [];
    state.communitiesHeader = data.communitiesHeader || [];
    state.communitiesRows = data.communities || [];

    renderAll();
    setStatus('–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã');
  }catch(e){
    setStatus('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ' + e.message, true);
  }finally{
    $('btn-refresh').disabled = false;
  }
}

/* ===============================
   RELEASE CRUD
   (requires GAS actions: updateRelease, deleteRelease)
================================ */
function openCreateReleaseModal(){
  openModal(
    '–°–æ–∑–¥–∞—Ç—å —Ä–µ–ª–∏–∑',
    `
      <div class="row">
        <input id="r-title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–ª–∏–∑–∞ (–∫–∞–∫ —É —Ç–µ–±—è –≤ –æ—Ç—á—ë—Ç–µ)" style="min-width:360px" />
        <input id="r-password" placeholder="–ü–∞—Ä–æ–ª—å –∞—Ä—Ç–∏—Å—Ç–∞" />
      </div>
      <div class="hint">–õ–æ–≥–∏–Ω (slug) –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏: —Ç—Ä–∞–Ω—Å–ª–∏—Ç ‚Üí kebab-case.</div>
      <pre id="r-out">‚Äî</pre>
    `,
    `
      <button class="secondary" type="button" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
      <button type="button" onclick="createRelease()">–°–æ–∑–¥–∞—Ç—å</button>
    `
  );
  setTimeout(()=>{ const el = document.getElementById('r-title'); if (el) el.focus(); }, 0);
}

async function createRelease(){
  try{
    const title = document.getElementById('r-title').value.trim();
    const password = document.getElementById('r-password').value.trim();
    if (!title) throw new Error('–£–∫–∞–∂–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–ª–∏–∑–∞');
    if (!password) throw new Error('–£–∫–∞–∂–∏ –ø–∞—Ä–æ–ª—å –∞—Ä—Ç–∏—Å—Ç–∞');

    const data = await api('createRelease', { title, password });
    setOut('r-out', data);

    await refresh();
    state.selectedReleaseId = data.release_id;
    state.selectedCommunityId = "";
    renderAll();

    setStatus('–†–µ–ª–∏–∑ —Å–æ–∑–¥–∞–Ω');
    closeModal();
  }catch(e){
    const out = document.getElementById('r-out');
    if (out) out.textContent = '–û—à–∏–±–∫–∞: ' + e.message;
    setStatus('–û—à–∏–±–∫–∞: ' + e.message, true);
  }
}

function openEditReleaseModal(){
  const rel = state.selectedReleaseId ? getReleaseById_(state.selectedReleaseId) : null;
  if (!rel) return;

  const h = state.releasesHeader;
  const title = rel[idx_(h,'title')] ?? '';
  const password = rel[idx_(h,'password')] ?? '';
  const ps = rel[idx_(h,'period_start')] ?? '';
  const pe = rel[idx_(h,'period_end')] ?? '';

  openModal(
    '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–ª–∏–∑',
    `
      <div class="row">
        <input id="er-title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–ª–∏–∑–∞" value="${esc_(title)}" style="min-width:360px" />
        <input id="er-password" placeholder="–ü–∞—Ä–æ–ª—å –∞—Ä—Ç–∏—Å—Ç–∞" value="${esc_(password)}" />
      </div>
      <div class="row" style="margin-top:10px">
        <input id="er-ps" placeholder="–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)" value="${esc_(ps)}" />
        <input id="er-pe" placeholder="–î–∞—Ç–∞ –∫–æ–Ω—Ü–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)" value="${esc_(pe)}" />
      </div>
      <div class="hint">
        –≠—Ç–∞ —Ñ–æ—Ä–º–∞ –æ–∂–∏–¥–∞–µ—Ç API-—ç–∫—à–µ–Ω <span class="mono">updateRelease</span> –≤ GAS.
      </div>
      <pre id="er-out">‚Äî</pre>
    `,
    `
      <button class="secondary" type="button" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
      <button type="button" onclick="updateRelease()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    `
  );
}

async function updateRelease(){
  try{
    const payload = {
      release_id: state.selectedReleaseId,
      title: document.getElementById('er-title').value.trim(),
      password: document.getElementById('er-password').value.trim(),
      period_start: document.getElementById('er-ps').value.trim(),
      period_end: document.getElementById('er-pe').value.trim()
    };
    if (!payload.title) throw new Error('–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');
    if (!payload.password) throw new Error('–ü–∞—Ä–æ–ª—å –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');

    const data = await api('updateRelease', payload);
    setOut('er-out', data);

    await refresh();
    setStatus('–†–µ–ª–∏–∑ –æ–±–Ω–æ–≤–ª—ë–Ω');
    closeModal();
  }catch(e){
    const out = document.getElementById('er-out');
    if (out) out.textContent = '–û—à–∏–±–∫–∞: ' + e.message;
    setStatus('–û—à–∏–±–∫–∞: ' + e.message, true);
  }
}

async function deleteRelease(){
  try{
    if (!state.selectedReleaseId) return;
    if (!confirmDanger_('–£–¥–∞–ª–∏—Ç—å —Ä–µ–ª–∏–∑ –∏ –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.')) return;

    await api('deleteRelease', { release_id: state.selectedReleaseId });
    state.selectedReleaseId = "";
    state.selectedCommunityId = "";

    await refresh();
    setStatus('–†–µ–ª–∏–∑ —É–¥–∞–ª—ë–Ω');
  }catch(e){
    setStatus('–û—à–∏–±–∫–∞: ' + e.message, true);
  }
}

/* ===============================
   COMMUNITY CRUD
   (requires GAS actions: updateCommunity, deleteCommunity)
================================ */
function openAddCommunityModal(){
  if (!state.selectedReleaseId) {
    setStatus('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ —Ä–µ–ª–∏–∑', true);
    return;
  }
  openModal(
    '–î–æ–±–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ—Å—Ç–≤–æ',
    `
      <div class="row">
        <input id="ac-id" placeholder="community_id (–Ω–∞–ø—Ä–∏–º–µ—Ä club123)" />
        <input id="ac-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä DJ DIMIXER)" style="min-width:360px" />
      </div>
      <div class="hint">
        –í–∞–∂–Ω–æ: VK-–≤—ã–≥—Ä—É–∑–∫–∏ (–∫–∞–º–ø–∞–Ω–∏–∏/–≥—Ä—É–ø–ø—ã/–æ–±—ä—è–≤–ª–µ–Ω–∏—è/—Å—Ç—Ä–∞–Ω—ã/–≥–æ—Ä–æ–¥–∞/–¥–µ–º–æ–≥—Ä–∞—Ñ–∏—è) –±—É–¥—É—Ç –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ —ç—Ç–æ–º—É <span class="mono">community_id</span>.
      </div>
      <pre id="ac-out">‚Äî</pre>
    `,
    `
      <button class="secondary" type="button" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
      <button type="button" onclick="addCommunity()">–î–æ–±–∞–≤–∏—Ç—å</button>
    `
  );
  setTimeout(()=>{ const el = document.getElementById('ac-id'); if (el) el.focus(); }, 0);
}

async function addCommunity(){
  try{
    const community_id = document.getElementById('ac-id').value.trim();
    const community_name = document.getElementById('ac-name').value.trim();
    if (!community_id || !community_name) throw new Error('–£–∫–∞–∂–∏ community_id –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ');

    const list = getCommunitiesForRelease_(state.selectedReleaseId);
    if (list.some(c => c.community_id === community_id)) throw new Error('–¢–∞–∫–æ–π community_id —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω');

    const sort_order = list.length + 1;
    const data = await api('addCommunity', { release_id: state.selectedReleaseId, community_id, community_name, sort_order });
    setOut('ac-out', data);

    await refresh();
    state.selectedCommunityId = community_id;
    renderAll();

    setStatus('–°–æ–æ–±—â–µ—Å—Ç–≤–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ');
    closeModal();
  }catch(e){
    const out = document.getElementById('ac-out');
    if (out) out.textContent = '–û—à–∏–±–∫–∞: ' + e.message;
    setStatus('–û—à–∏–±–∫–∞: ' + e.message, true);
  }
}

function openEditCommunityModal(cid){
  const relId = state.selectedReleaseId;
  if (!relId) return;
  const list = getCommunitiesForRelease_(relId);
  const targetId = cid || state.selectedCommunityId;
  const c = list.find(x => x.community_id === targetId);
  if (!c) return;

  openModal(
    '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ—Å—Ç–≤–æ',
    `
      <div class="row">
        <input id="ec-id" placeholder="community_id" value="${esc_(c.community_id)}" />
        <input id="ec-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞" value="${esc_(c.community_name)}" style="min-width:360px" />
      </div>
      <div class="row" style="margin-top:10px">
        <input id="ec-sort" placeholder="sort_order" value="${esc_(c.sort_order)}" />
      </div>
      <div class="hint">
        –≠—Ç–∞ —Ñ–æ—Ä–º–∞ –æ–∂–∏–¥–∞–µ—Ç API-—ç–∫—à–µ–Ω <span class="mono">updateCommunity</span> –≤ GAS. –ï—Å–ª–∏ –º–µ–Ω—è–µ—à—å community_id, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ new_community_id.
      </div>
      <pre id="ec-out">‚Äî</pre>
    `,
    `
      <button class="secondary" type="button" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
      <button type="button" onclick="updateCommunity('${esc_(c.community_id)}')">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    `
  );
}

async function updateCommunity(originalId){
  try{
    const new_community_id = document.getElementById('ec-id').value.trim();
    const community_name = document.getElementById('ec-name').value.trim();
    const sort_order = Number(document.getElementById('ec-sort').value || 0);

    if (!new_community_id || !community_name) throw new Error('community_id –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã');

    const data = await api('updateCommunity', {
      release_id: state.selectedReleaseId,
      community_id: originalId,
      new_community_id,
      community_name,
      sort_order
    });
    setOut('ec-out', data);

    await refresh();
    state.selectedCommunityId = new_community_id;
    renderAll();
    setStatus('–°–æ–æ–±—â–µ—Å—Ç–≤–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ');
    closeModal();
  }catch(e){
    const out = document.getElementById('ec-out');
    if (out) out.textContent = '–û—à–∏–±–∫–∞: ' + e.message;
    setStatus('–û—à–∏–±–∫–∞: ' + e.message, true);
  }
}

async function deleteCommunity(cid){
  try{
    const relId = state.selectedReleaseId;
    const community_id = cid || state.selectedCommunityId;
    if (!relId || !community_id) return;

    if (!confirmDanger_('–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ—Å—Ç–≤–æ –∏ –≤—Å–µ –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–µ –∫ –Ω–µ–º—É VK-–¥–∞–Ω–Ω—ã–µ (RAW) –¥–ª—è —ç—Ç–æ–≥–æ —Ä–µ–ª–∏–∑–∞?')) return;

    await api('deleteCommunity', { release_id: relId, community_id });

    if (state.selectedCommunityId === community_id) state.selectedCommunityId = "";

    await refresh();
    renderAll();
    setStatus('–°–æ–æ–±—â–µ—Å—Ç–≤–æ —É–¥–∞–ª–µ–Ω–æ');
  }catch(e){
    setStatus('–û—à–∏–±–∫–∞: ' + e.message, true);
  }
}

/* ===============================
   PUBLISH
================================ */
async function togglePublish(){
  try{
    const release_id = state.selectedReleaseId;
    if (!release_id) throw new Error('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ —Ä–µ–ª–∏–∑');

    const rel = getReleaseById_(release_id);
    const publishedRaw = rel[idx_(state.releasesHeader,'published')];
    const published = (publishedRaw === true || String(publishedRaw).toLowerCase() === 'true');

    await api('publishRelease', { release_id, published: !published });
    await refresh();
    setStatus(!published ? '–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ' : '–°–Ω—è—Ç–æ —Å –ø—É–±–ª–∏–∫–∞—Ü–∏–∏');
  }catch(e){
    setStatus('–û—à–∏–±–∫–∞: ' + e.message, true);
  }
}

/* ===============================
   UPLOADS
================================ */
function getCtx_(){
  if (!state.selectedReleaseId) throw new Error('–í—ã–±–µ—Ä–∏ —Ä–µ–ª–∏–∑');
  if (!state.selectedCommunityId) throw new Error('–í—ã–±–µ—Ä–∏ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ');
  return { release_id: state.selectedReleaseId, community_id: state.selectedCommunityId };
}

async function uploadVkKind(kind, fileInputId, outId){
  try{
    const { release_id, community_id } = getCtx_();
    const file = $(fileInputId).files[0];
    if (!file) throw new Error('–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω');

    const rows = await readExcelFirstSheet(file);
    const header = rows.shift();
    const dataRows = rows.filter(r => r && r.length && r.some(v => String(v ?? '').trim() !== ''));

    const resp = await api('uploadVkTable', { kind, release_id, community_id, header, rows: dataRows });
    setOut(outId, resp);
    setStatus(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${kind} ¬∑ ${resp.added ?? 0} —Å—Ç—Ä–æ–∫`);
  }catch(e){
    setOut(outId, '–û—à–∏–±–∫–∞: ' + e.message);
    setStatus('–û—à–∏–±–∫–∞: ' + e.message, true);
  }
}

async function uploadDemoGeoKind(kind, fileInputId, outId){
  try{
    const { release_id, community_id } = getCtx_();
    const file = $(fileInputId).files[0];
    if (!file) throw new Error('–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω');

    const all = await readExcelFirstSheet(file);
    const meta = all.slice(0,5);
    const header = all[5];
    const rows = all.slice(6).filter(r => r && r.length && r.some(v => String(v ?? '').trim() !== ''));

    const campaign_id = String((meta[0] && meta[0][1]) || '').trim();
    const campaign_name = String((meta[1] && meta[1][1]) || '').trim();
    const period_from = String((meta[3] && meta[3][1]) || '').trim();
    const period_to = String((meta[4] && meta[4][1]) || '').trim();

    const resp = await api('uploadDemoGeoTable', {
      kind, release_id, community_id,
      campaign_id, campaign_name, period_from, period_to,
      header, rows
    });

    setOut(outId, resp);
    setStatus(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${kind} ¬∑ ${resp.added ?? 0} —Å—Ç—Ä–æ–∫`);
  }catch(e){
    setOut(outId, '–û—à–∏–±–∫–∞: ' + e.message);
    setStatus('–û—à–∏–±–∫–∞: ' + e.message, true);
  }
}

async function deleteRaw(kind, outId){
  try{
    const { release_id, community_id } = getCtx_();
    if (!confirmDanger_('–£–¥–∞–ª–∏—Ç—å –ø—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞?')) return;
    const resp = await api('deleteRawTable', { kind, release_id, community_id });
    setOut(outId, resp);
    setStatus(`–£–¥–∞–ª–µ–Ω–æ: ${kind} ¬∑ ${resp.deleted ?? 0} —Å—Ç—Ä–æ–∫`);
  }catch(e){
    setOut(outId, '–û—à–∏–±–∫–∞: ' + e.message);
    setStatus('–û—à–∏–±–∫–∞: ' + e.message, true);
  }
}

async function uploadStreams(){
  try{
    const release_id = state.selectedReleaseId;
    if (!release_id) throw new Error('–í—ã–±–µ—Ä–∏ —Ä–µ–ª–∏–∑');
    const file = $('streams-file').files[0];
    if (!file) throw new Error('–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω');

    const rows = await readExcelFirstSheet(file);
    const first = rows[0] || [];
    const looksHeader = String(first[0] || '').toLowerCase().includes('–¥–∞—Ç–∞') || String(first[0] || '').toLowerCase().includes('date');
    if (looksHeader) rows.shift();

    const header = ["date","streams_ok","streams_vk","streams_yandex"];
    const dataRows = rows
      .filter(r => r && r.length && r.some(v => String(v ?? '').trim() !== ''))
      .map(r => [r[0] ?? '', r[1] ?? '', r[2] ?? '', r[3] ?? '']);

    const resp = await api('uploadStreams', { release_id, header, rows: dataRows });
    setOut('streams-out', resp);
    setStatus(`–°—Ç—Ä–∏–º—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã ¬∑ ${resp.added ?? 0} —Å—Ç—Ä–æ–∫`);
  }catch(e){
    setOut('streams-out', '–û—à–∏–±–∫–∞: ' + e.message);
    setStatus('–û—à–∏–±–∫–∞: ' + e.message, true);
  }
}

async function deleteStreams(){
  try{
    const release_id = state.selectedReleaseId;
    if (!release_id) throw new Error('–í—ã–±–µ—Ä–∏ —Ä–µ–ª–∏–∑');
    if (!confirmDanger_('–£–¥–∞–ª–∏—Ç—å —Å—Ç—Ä–∏–º—ã –¥–ª—è —Ä–µ–ª–∏–∑–∞?')) return;
    const resp = await api('deleteStreams', { release_id });
    setOut('streams-out', resp);
    setStatus(`–°—Ç—Ä–∏–º—ã —É–¥–∞–ª–µ–Ω—ã ¬∑ ${resp.deleted ?? 0} —Å—Ç—Ä–æ–∫`);
  }catch(e){
    setOut('streams-out', '–û—à–∏–±–∫–∞: ' + e.message);
    setStatus('–û—à–∏–±–∫–∞: ' + e.message, true);
  }
}

/* ===============================
   BIND + INIT
================================ */
$('btn-refresh').addEventListener('click', refresh);
$('btn-publish').addEventListener('click', togglePublish);

$('release-select').addEventListener('change', () => {
  state.selectedReleaseId = $('release-select').value || "";
  state.selectedCommunityId = "";
  renderAll();
});

$('community-select').addEventListener('change', () => {
  selectCommunity($('community-select').value || "");
});

loadState_();
refresh();
</script>

<!-- 1) Releases -->
<div class="card">
  <div class="headerRow">
    <div class="stepTitle">
      <span class="stepDot">1</span>
      <h3>–†–µ–ª–∏–∑</h3>
    </div>
    <button class="iconBtn" type="button" title="–°–æ–∑–¥–∞—Ç—å —Ä–µ–ª–∏–∑" onclick="openCreateReleaseModal()">Ôºã</button>
  </div>

  <div class="row" style="margin-top:10px">
    <select id="release-select"></select>
  </div>

  <div id="release-summary" style="margin-top:10px"></div>
  <div id="global-status" class="status muted">‚Äî</div>
</div>

<!-- 2) Community -->
<div class="card">
  <div class="headerRow">
    <div class="stepTitle">
      <span class="stepDot">2</span>
      <h3>–°–æ–æ–±—â–µ—Å—Ç–≤–æ</h3>
    </div>
    <div class="row">
      <select id="community-select" title="–í—ã–±–æ—Ä —Å–æ–æ–±—â–µ—Å—Ç–≤–∞"></select>
    </div>
  </div>

  <div id="community-summary" style="margin-top:10px"></div>
  <div id="community-table"></div>
</div>

<!-- 3) VK Uploads -->
<div class="card flat" style="padding:0;border:none;background:transparent;box-shadow:none;margin-bottom:8px">
  <div class="stepTitle">
    <span class="stepDot">3</span>
    <h3>VK-–≤—ã–≥—Ä—É–∑–∫–∏ (–ø—Ä–∏–≤—è–∑—ã–≤–∞—é—Ç—Å—è –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —Å–æ–æ–±—â–µ—Å—Ç–≤—É)</h3>
  </div>
  <div class="hint">
    –ö–∞–º–ø–∞–Ω–∏–∏ / –ì—Ä—É–ø–ø—ã / –û–±—ä—è–≤–ª–µ–Ω–∏—è / –î–µ–º–æ–≥—Ä–∞—Ñ–∏—è / –°—Ç—Ä–∞–Ω—ã / –ì–æ—Ä–æ–¥–∞ ‚Äî –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ –Ω–∞ –∫–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ.
    –î–ª—è —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã –Ω–∞–∂–º–∏ ¬´‚úï¬ª –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–µ.
  </div>
</div>

<div class="grid">
  <div class="card" data-block="vk">
    <div class="headerRow">
      <h3>–ö–∞–º–ø–∞–Ω–∏–∏</h3>
      <button class="iconBtn danger" type="button" data-requires="community" onclick="deleteRaw('campaigns','out-campaigns')" title="–£–¥–∞–ª–∏—Ç—å –ø—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É">‚úï</button>
    </div>
    <div class="row" style="margin-top:10px">
      <input type="file" id="file-campaigns" data-requires="community" accept=".xlsx" />
      <button type="button" data-requires="community" onclick="uploadVkKind('campaigns','file-campaigns','out-campaigns')">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
    </div>
    <pre id="out-campaigns">‚Äî</pre>
  </div>

  <div class="card" data-block="vk">
    <div class="headerRow">
      <h3>–ì—Ä—É–ø–ø—ã</h3>
      <button class="iconBtn danger" type="button" data-requires="community" onclick="deleteRaw('groups','out-groups')" title="–£–¥–∞–ª–∏—Ç—å –ø—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É">‚úï</button>
    </div>
    <div class="row" style="margin-top:10px">
      <input type="file" id="file-groups" data-requires="community" accept=".xlsx" />
      <button type="button" data-requires="community" onclick="uploadVkKind('groups','file-groups','out-groups')">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
    </div>
    <pre id="out-groups">‚Äî</pre>
  </div>

  <div class="card" data-block="vk">
    <div class="headerRow">
      <h3>–û–±—ä—è–≤–ª–µ–Ω–∏—è</h3>
      <button class="iconBtn danger" type="button" data-requires="community" onclick="deleteRaw('ads','out-ads')" title="–£–¥–∞–ª–∏—Ç—å –ø—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É">‚úï</button>
    </div>
    <div class="row" style="margin-top:10px">
      <input type="file" id="file-ads" data-requires="community" accept=".xlsx" />
      <button type="button" data-requires="community" onclick="uploadVkKind('ads','file-ads','out-ads')">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
    </div>
    <pre id="out-ads">‚Äî</pre>
  </div>

  <div class="card" data-block="vk">
    <div class="headerRow">
      <h3>–î–µ–º–æ–≥—Ä–∞—Ñ–∏—è</h3>
      <button class="iconBtn danger" type="button" data-requires="community" onclick="deleteRaw('demo','out-demo')" title="–£–¥–∞–ª–∏—Ç—å –ø—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É">‚úï</button>
    </div>
    <div class="row" style="margin-top:10px">
      <input type="file" id="file-demo" data-requires="community" accept=".xlsx" />
      <button type="button" data-requires="community" onclick="uploadDemoGeoKind('demo','file-demo','out-demo')">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
    </div>
    <pre id="out-demo">‚Äî</pre>
  </div>

  <div class="card" data-block="vk">
    <div class="headerRow">
      <h3>–°—Ç—Ä–∞–Ω—ã</h3>
      <button class="iconBtn danger" type="button" data-requires="community" onclick="deleteRaw('countries','out-countries')" title="–£–¥–∞–ª–∏—Ç—å –ø—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É">‚úï</button>
    </div>
    <div class="row" style="margin-top:10px">
      <input type="file" id="file-countries" data-requires="community" accept=".xlsx" />
      <button type="button" data-requires="community" onclick="uploadDemoGeoKind('countries','file-countries','out-countries')">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
    </div>
    <pre id="out-countries">‚Äî</pre>
  </div>

  <div class="card" data-block="vk">
    <div class="headerRow">
      <h3>–ì–æ—Ä–æ–¥–∞</h3>
      <button class="iconBtn danger" type="button" data-requires="community" onclick="deleteRaw('cities','out-cities')" title="–£–¥–∞–ª–∏—Ç—å –ø—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É">‚úï</button>
    </div>
    <div class="row" style="margin-top:10px">
      <input type="file" id="file-cities" data-requires="community" accept=".xlsx" />
      <button type="button" data-requires="community" onclick="uploadDemoGeoKind('cities','file-cities','out-cities')">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
    </div>
    <pre id="out-cities">‚Äî</pre>
  </div>
</div>

<!-- 4) Streams -->
<div class="card" data-block="streams">
  <div class="headerRow">
    <div class="stepTitle">
      <span class="stepDot">4</span>
      <h3>–°—Ç—Ä–∏–º–∏–Ω–≥–∏ (–Ω–∞ –≤–µ—Å—å —Ä–µ–ª–∏–∑)</h3>
    </div>
    <button class="iconBtn danger" type="button" data-requires="release" onclick="deleteStreams()" title="–£–¥–∞–ª–∏—Ç—å —Å—Ç—Ä–∏–º—ã">‚úï</button>
  </div>
  <div class="hint">–≠—Ç–∞ –∑–∞–≥—Ä—É–∑–∫–∞ –Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å–æ–æ–±—â–µ—Å—Ç–≤–∞ –∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –¥–ª—è —Ä–µ–ª–∏–∑–∞.</div>
  <div class="row" style="margin-top:10px">
    <input type="file" id="streams-file" data-requires="release" accept=".xlsx" />
    <button type="button" data-requires="release" onclick="uploadStreams()">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
  </div>
  <pre id="streams-out">‚Äî</pre>
</div>

</body>
</html>
